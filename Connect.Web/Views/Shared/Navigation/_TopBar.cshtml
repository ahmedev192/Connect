@using Microsoft.AspNetCore.Identity
@inject UserManager<User> userManager;

@* @using System.Security.Claims; *@
@{

	var loggedInUser = await userManager.GetUserAsync(User);
	var userName = loggedInUser?.UserName;
	var fullName = loggedInUser?.FullName;
	var profilePictureUrl = loggedInUser?.ProfilePictureUrl;
}

<header class="z-[100] h-[--m-top] top-0 left-0 bg-white/80 sky-50 border-slate-200 fixed flex w-full items-center border-b backdrop-blur-xl">
	<div class="lg:w-[--w-side-sm] 2xl:w-[--w-side]">
		<div class="gap-1 flex items-center">
			<button uk-toggle="target: #site__sidebar ; cls :!-translate-x-0"
					class="w-8 h-8 group flex items-center justify-center rounded-full text-xl hover:bg-gray-100 xl:hidden">
				<ion-icon name="menu-outline" class="text-2xl group-aria-expanded:hidden"></ion-icon>
				<ion-icon name="close-outline" class="hidden text-2xl group-aria-expanded:block"></ion-icon>
			</button>

			<div id="logo" class="flex items-center">
				<a asp-controller="Home" asp-action="Index" class="flex items-center">
					<img src="~/images/logo.png" class="w-10 hidden md:block" />
					<span class="ml-2">Connect App</span>
				</a>
			</div>

		</div>
	</div>
	<div class="relative flex-1">
		<div class="mx-auto flex max-w-[1220px] items-center">
			<form id="search--box"
				  class="bg-secondery left-0 z-20 w-screen overflow-hidden rounded-xl sm:w-96 sm:relative xl:w-[680px] max-md:hidden max-sm:fixed max-sm:top-2">

				<ion-icon name="search" class="left-4 -translate-y-1/2 absolute top-1/2"></ion-icon>
				<input type="text" name="query" placeholder="Search Posts, Friends..." class="!pl-10 !bg-transparent h-12 w-full !text-sm !font-normal" />
			</form>
		</div>

		<div class="mx-auto flex max-w-[1220px] items-center">
			<div class="gap-2 right-5 -translate-y-1/2 text-black absolute top-1/2 flex items-center sm:gap-4">

				@* notification icon *@
                <button type="button" class="p-1 relative rounded-full sm:p-2 sm:bg-secondery" id="notificationsBtn">

					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 max-sm:hidden">
						<path d="M5.85 3.5a.75.75 0 00-1.117-1 9.719 9.719 0 00-2.348 4.876.75.75 0 001.479.248A8.219 8.219 0 015.85 3.5zM19.267 2.5a.75.75 0 10-1.118 1 8.22 8.22 0 011.987 4.124.75.75 0 001.48-.248A9.72 9.72 0 0019.266 2.5z" />
						<path fill-rule="evenodd" d="M12 2.25A6.75 6.75 0 005.25 9v.75a8.217 8.217 0 01-2.119 5.52.75.75 0 00.298 1.206c1.544.57 3.16.99 4.831 1.243a3.75 3.75 0 107.48 0 24.583 24.583 0 004.83-1.244.75.75 0 00.298-1.205 8.217 8.217 0 01-2.118-5.52V9A6.75 6.75 0 0012 2.25zM9.75 18c0-.034 0-.067.002-.1a25.05 25.05 0 004.496 0l.002.1a2.25 2.25 0 11-4.5 0z" clip-rule="evenodd" />
					</svg>
					<div class="top-0 right-0 -m-1 bg-red-600 text-white px-1 absolute rounded-full text-xs" id="notificationsCount">0</div>
				</button>

				<div class="bg-white pr-1.5 border2 hidden w-screen rounded-lg drop-shadow-xl md:w-[365px]" uk-drop="offset:6;pos: bottom-right; mode: click; animate-out: true;">

					<div class="gap-2 p-4 pb-2 flex items-center justify-between">
						<h3 class="text-xl font-bold">Notifications</h3>
					</div>

					<div class="pr-2 h-[400px] w-full overflow-y-auto text-sm">
						<div class="pl-2 p-1 text-sm font-normal" id="notification-dropdown">
							No notifications...
						</div>
					</div>

				</div>

				<div class="bg-secondery relative shrink-0 cursor-pointer rounded-full">
					<img src="@profilePictureUrl" class="w-7 h-7 shrink-0 rounded-full shadow sm:w-9 sm:h-9" />
				</div>
				<div class="bg-white w-64 border2 hidden rounded-lg drop-shadow-xl" uk-drop="offset:6;pos: bottom-right;animate-out: true;">

					<a>
						<div class="p-4 py-5 gap-4 flex items-center">
							<img src="@profilePictureUrl" class="w-10 h-10 rounded-full shadow" />
							<div class="flex-1">
								<h4 class="text-black text-sm font-medium">@fullName</h4>
								<div class="mt-1 text-blue-600 font-light/70 text-sm">@@@userName</div>
							</div>
						</div>
					</a>
					<hr />
					<nav>
						<a asp-controller="Profile" asp-action="Index">
							<div class="gap-2.5 p-2 px-2.5 flex items-center rounded-md hover:bg-secondery">
								<ion-icon name="settings-outline" class="text-lg"></ion-icon> My Account
							</div>
						</a>
						<hr />
						<form asp-controller="Account" asp-action="Logout" method="post" class="w-full">
							<button type="submit" class="w-full text-left">
								<div class="gap-2.5 p-2 px-2.5 flex items-center rounded-md hover:bg-secondery">
									<ion-icon name="exit-outline" class="text-lg"></ion-icon> Log Out
								</div>
							</button>
						</form>

					</nav>
				</div>
			</div>
		</div>
	</div>
</header>


<script src="https://cdnjs.cloudflare.com/ajax/libs/aspnet-signalr/1.0.27/signalr.min.js" integrity="sha512-a+73ErrZPjhqOu0qbW1QLsenEF4pvDjmnd+Ws6hkDyJlrwAigOQAxQhIT+fPNFWScUvtJQvn+G535TT2C6/G4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
	document.addEventListener("DOMContentLoaded", () => {

		fetch("/Notification/GetCount", {
			method: 'GET',
			headers: {
				'Content-Type':'application/json'
			}
		})
			.then(response => response.json())
			.then(data => {
				console.log("notifications count = ", data);
				document.getElementById("notificationsCount").innerHTML = data;
			})
			.catch(error => {
				console.error("Error fetching notification count: ", error);
			})


		document.getElementById('notificationsBtn').addEventListener('click', () => {
			fetch('/Notification/GetNotifications')
				.then(resp => resp.text())
				.then(html => {
					document.getElementById('notification-dropdown').innerHTML = html;
				})
		})

		//SignalR connection
		const connection = new signalR.HubConnectionBuilder()
			.withUrl("/notificationHub")
			.build();

		connection.on("ReceiveNotification", (message) => {
			console.log("message ==> ", message);

			document.getElementById("notificationsCount").innerHTML = message;
		});

		connection.start()
			.then(() => console.log("SignalR connected"))
			.catch((err) => console.log("SignalR connection error: ", err))

	})

	function setNotificationAsRead(notificationId) {
		console.log('Mark as read => notification => ', notificationId);

		fetch(`/Notification/SetNotificationAsRead?notificationId=${notificationId}`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(resp => resp.text())
			.then(html => {
				document.getElementById('notification-dropdown').innerHTML = html;
			})
	}
</script>